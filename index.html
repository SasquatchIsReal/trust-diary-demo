<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trust Diary P2P Client</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0a0e27;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            color: #8892b0;
            margin-bottom: 30px;
        }
        .card {
            background: #112240;
            border: 1px solid #233554;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        .status.connected { background: #10b981; }
        .status.connecting { background: #f59e0b; }
        .status.disconnected { background: #64748b; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            background: #0a0e27;
            border: 1px solid #233554;
            color: #fff;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }
        #messages {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #0a0e27;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .message {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .peer {
            display: inline-block;
            padding: 5px 10px;
            background: #233554;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        .section {
            margin-top: 30px;
        }
        code {
            background: #233554;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Trust Diary P2P</h1>
        <p class="subtitle">Serverless, peer-to-peer diary sharing via WebTorrent</p>

        <div class="status disconnected" id="status">Disconnected</div>

        <div class="card">
            <h2>Quick Start</h2>
            <p style="margin-bottom: 15px;">Enter a room name to join or create a P2P room:</p>
            <input type="text" id="roomName" placeholder="e.g., my-secret-diary" value="trust-diary-demo">
            <button onclick="connect()">üöÄ Connect to Room</button>
            <button onclick="disconnect()" disabled id="disconnectBtn">üîå Disconnect</button>
        </div>

        <div class="card" id="connectionInfo" style="display: none;">
            <h3>Connected Peers</h3>
            <div id="peers">No peers yet...</div>
        </div>

        <div class="card section">
            <h3>Share Diary Entry</h3>
            <input type="text" id="entryTitle" placeholder="Entry title...">
            <textarea id="entryContent" placeholder="Write your diary entry..." rows="4"></textarea>
            <button onclick="sendEntry()" id="sendBtn" disabled>üì§ Send Entry</button>
        </div>

        <div class="card section">
            <h3>Received Entries</h3>
            <div id="messages">
                <p style="color: #8892b0;">No entries yet. Connect to a room to start receiving.</p>
            </div>
        </div>

        <div class="card section" style="background: #1e293b;">
            <h3>How It Works</h3>
            <ol style="line-height: 1.8; color: #8892b0;">
                <li>üåê Uses WebTorrent trackers for peer discovery (no server needed)</li>
                <li>üîê Room names act as private keys - only those who know the name can join</li>
                <li>üì° Direct P2P connections between browsers via WebRTC</li>
                <li>üöÄ Works from GitHub Pages, local files, or any static host</li>
                <li>üîí All communication is peer-to-peer, no data touches our servers</li>
            </ol>
        </div>
    </div>

    <script>
        let room = null;
        let sendMessage = null;
        let peers = new Set();

        function connect() {
            const roomName = document.getElementById('roomName').value.trim();
            if (!roomName) {
                alert('Please enter a room name');
                return;
            }

            updateStatus('connecting');

            // Join room using Trystero with WebTorrent
            room = window.joinRoom({ appId: 'trust-diary' }, roomName);

            // Get send function
            const [send, receive] = room.makeAction('diary-entry');
            sendMessage = send;

            // Handle peer connections
            room.onPeerJoin(peerId => {
                console.log(`Peer joined: ${peerId}`);
                peers.add(peerId);
                updatePeers();
                addMessage(`üü¢ Peer joined: ${peerId.substring(0, 8)}...`, 'system');

                if (peers.size === 1) {
                    updateStatus('connected');
                }
            });

            room.onPeerLeave(peerId => {
                console.log(`Peer left: ${peerId}`);
                peers.delete(peerId);
                updatePeers();
                addMessage(`üî¥ Peer left: ${peerId.substring(0, 8)}...`, 'system');

                if (peers.size === 0) {
                    updateStatus('connecting');
                }
            });

            // Receive messages
            receive((data, peerId) => {
                console.log('Received:', data);
                displayEntry(data, peerId);
            });

            // Update UI
            document.getElementById('roomName').disabled = true;
            document.querySelector('button[onclick="connect()"]').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('connectionInfo').style.display = 'block';

            addMessage(`üì° Connecting to room: ${roomName}`, 'system');
            updateStatus('connecting');
        }

        function disconnect() {
            if (room) {
                room.leave();
                room = null;
                sendMessage = null;
                peers.clear();
                updatePeers();
            }

            // Update UI
            document.getElementById('roomName').disabled = false;
            document.querySelector('button[onclick="connect()"]').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('connectionInfo').style.display = 'none';

            updateStatus('disconnected');
            addMessage('üîå Disconnected from room', 'system');
        }

        function sendEntry() {
            if (!sendMessage) {
                alert('Not connected to a room');
                return;
            }

            const title = document.getElementById('entryTitle').value.trim();
            const content = document.getElementById('entryContent').value.trim();

            if (!title || !content) {
                alert('Please enter both title and content');
                return;
            }

            const entry = {
                title,
                content,
                timestamp: new Date().toISOString(),
                author: 'Me'
            };

            // Send to all peers
            sendMessage(entry);

            // Display locally
            displayEntry(entry, 'self');

            // Clear form
            document.getElementById('entryTitle').value = '';
            document.getElementById('entryContent').value = '';

            addMessage(`üì§ Sent entry: "${title}"`, 'system');
        }

        function displayEntry(entry, peerId) {
            const messagesDiv = document.getElementById('messages');

            // Clear placeholder if needed
            if (messagesDiv.querySelector('p')) {
                messagesDiv.innerHTML = '';
            }

            const entryDiv = document.createElement('div');
            entryDiv.className = 'message';
            entryDiv.innerHTML = `
                <strong>${entry.title}</strong>
                <div style="color: #8892b0; font-size: 0.8em; margin: 5px 0;">
                    ${new Date(entry.timestamp).toLocaleString()} ‚Ä¢
                    ${peerId === 'self' ? 'You' : `Peer ${peerId.substring(0, 8)}...`}
                </div>
                <div style="margin-top: 10px;">${entry.content}</div>
            `;

            messagesDiv.insertBefore(entryDiv, messagesDiv.firstChild);
        }

        function addMessage(text, type = 'normal') {
            console.log(text);
        }

        function updateStatus(state) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${state}`;

            switch(state) {
                case 'connected':
                    statusEl.textContent = `Connected (${peers.size} peer${peers.size !== 1 ? 's' : ''})`;
                    break;
                case 'connecting':
                    statusEl.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                    statusEl.textContent = 'Disconnected';
                    break;
            }
        }

        function updatePeers() {
            const peersDiv = document.getElementById('peers');
            if (peers.size === 0) {
                peersDiv.innerHTML = '<span style="color: #8892b0;">Waiting for peers...</span>';
            } else {
                peersDiv.innerHTML = Array.from(peers)
                    .map(p => `<span class="peer">${p.substring(0, 8)}...</span>`)
                    .join('');
            }
        }

        // Auto-connect on load if room name is provided
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const room = params.get('room');
            if (room) {
                document.getElementById('roomName').value = room;
                setTimeout(connect, 500);
            }
        });
    </script>
</body>
</html>